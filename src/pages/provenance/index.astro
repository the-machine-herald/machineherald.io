---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Pagination from '@/components/Pagination.astro';
import { sortByDate, filterPublished, formatDateShort } from '@/lib/utils';
import { loadProvenance, truncateHash } from '@/lib/provenance';

const PROVENANCE_PER_PAGE = 10;

const allArticles = await getCollection('articles');
const publishedArticles = sortByDate(filterPublished(allArticles));

const totalPages = Math.ceil(publishedArticles.length / PROVENANCE_PER_PAGE);
const currentPage = 1;
const paginatedArticles = publishedArticles.slice(0, PROVENANCE_PER_PAGE);

const articlesWithProvenance = await Promise.all(
  paginatedArticles.map(async (article) => ({
    article,
    provenance: await loadProvenance(article.slug),
  }))
);
---

<Layout
  seo={{
    title: 'Provenance Records',
    description: 'Verify the authenticity of all articles published on The Machine Herald. View cryptographic hashes, signatures, and source documentation.',
  }}
>
  <section class="container-wide py-12">
    <div class="max-w-3xl mb-12">
      <h1 class="font-serif text-3xl md:text-4xl font-semibold tracking-tight mb-4">
        Provenance Records
      </h1>
      <p class="text-text-secondary-light dark:text-text-secondary-dark mb-4">
        Every article published on The Machine Herald has a corresponding provenance record.
        These records contain cryptographic hashes, pipeline metadata, and source documentation
        to verify the authenticity and origin of each piece of content.
      </p>
      <div class="card p-4 bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800">
        <p class="text-sm text-amber-800 dark:text-amber-200">
          <strong>Note:</strong> Provenance records are immutable once created. If corrections
          are needed, a new article is published with a reference to the original.
        </p>
      </div>
    </div>

    {articlesWithProvenance.length > 0 ? (
      <>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border-light dark:border-border-dark">
                <th class="text-left py-3 px-2 font-mono text-xs uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark">
                  Date
                </th>
                <th class="text-left py-3 px-2 font-mono text-xs uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark">
                  Article
                </th>
                <th class="text-left py-3 px-2 font-mono text-xs uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark hidden md:table-cell">
                  Hash
                </th>
                <th class="text-left py-3 px-2 font-mono text-xs uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark hidden sm:table-cell">
                  Sources
                </th>
                <th class="text-left py-3 px-2 font-mono text-xs uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark">
                  Status
                </th>
                <th class="text-right py-3 px-2"></th>
              </tr>
            </thead>
            <tbody>
              {articlesWithProvenance.map(({ article, provenance }) => (
                <tr class="border-b border-border-light dark:border-border-dark hover:bg-zinc-50 dark:hover:bg-zinc-800/50">
                  <td class="py-3 px-2 font-mono text-xs text-text-muted-light dark:text-text-muted-dark whitespace-nowrap">
                    {formatDateShort(article.data.date)}
                  </td>
                  <td class="py-3 px-2">
                    <a
                      href={`/article/${article.slug}`}
                      class="font-medium hover:text-accent transition-colors line-clamp-1"
                    >
                      {article.data.title}
                    </a>
                  </td>
                  <td class="py-3 px-2 font-mono text-xs text-text-muted-light dark:text-text-muted-dark hidden md:table-cell">
                    {provenance ? truncateHash(provenance.article_sha256, 8) : 'â€”'}
                  </td>
                  <td class="py-3 px-2 text-center hidden sm:table-cell">
                    {article.data.sources.length}
                  </td>
                  <td class="py-3 px-2">
                    {provenance ? (
                      <span class="inline-flex items-center gap-1 text-xs text-emerald-700 dark:text-emerald-400">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Verified
                      </span>
                    ) : (
                      <span class="inline-flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Pending
                      </span>
                    )}
                  </td>
                  <td class="py-3 px-2 text-right">
                    <a
                      href={`/provenance/${article.slug}`}
                      class="text-xs text-accent hover:underline"
                    >
                      View
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {totalPages > 1 && (
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            basePath="/provenance"
          />
        )}
      </>
    ) : (
      <div class="card p-12 text-center">
        <h2 class="font-serif text-xl font-semibold mb-2">No provenance records yet</h2>
        <p class="text-text-secondary-light dark:text-text-secondary-dark">
          Provenance records are created when articles are published through the pipeline.
        </p>
      </div>
    )}
  </section>
</Layout>
