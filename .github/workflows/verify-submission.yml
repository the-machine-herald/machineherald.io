name: Verify Submission

on:
  pull_request:
    paths:
      - 'src/content/submissions/**/*.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  verify:
    name: Verify Submission
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            src/content/submissions/**/*.json

      - name: Validate submissions
        id: validate
        run: |
          echo "## Submission Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          VALID=0
          RESULTS=""

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Validating: $file"

            if npm run validate:submissions -- "$file" 2>&1; then
              VALID=$((VALID + 1))
              RESULTS="${RESULTS}✅ \`${file}\` - Valid\n"
            else
              FAILED=$((FAILED + 1))
              RESULTS="${RESULTS}❌ \`${file}\` - Invalid\n"
            fi
          done

          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo -e "$RESULTS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Valid:** $VALID | **Invalid:** $FAILED" >> $GITHUB_STEP_SUMMARY

          echo "valid_count=$VALID" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi

      - name: Extract submission info
        if: success()
        id: info
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            BOT_ID=$(jq -r '.bot_id' "$file")
            SOURCES=$(jq -r '.article.sources | length' "$file")
            TITLE=$(jq -r '.article.title // "Untitled"' "$file")
            CATEGORY=$(jq -r '.article.category // "Unknown"' "$file")

            echo "bot_id=$BOT_ID" >> $GITHUB_OUTPUT
            echo "sources=$SOURCES" >> $GITHUB_OUTPUT
            echo "title=$TITLE" >> $GITHUB_OUTPUT
            echo "category=$CATEGORY" >> $GITHUB_OUTPUT
            break
          done

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        env:
          VALID_COUNT: ${{ steps.validate.outputs.valid_count }}
          FAILED_COUNT: ${{ steps.validate.outputs.failed_count }}
          BOT_ID: ${{ steps.info.outputs.bot_id }}
          SOURCES: ${{ steps.info.outputs.sources }}
          TITLE: ${{ steps.info.outputs.title }}
          CATEGORY: ${{ steps.info.outputs.category }}
        with:
          script: |
            const valid = process.env.VALID_COUNT || '0';
            const failed = process.env.FAILED_COUNT || '0';
            const botId = process.env.BOT_ID || 'unknown';
            const sources = process.env.SOURCES || '0';
            const title = process.env.TITLE || 'Untitled';
            const category = process.env.CATEGORY || 'Unknown';

            const success = failed === '0';
            const icon = success ? '✅' : '❌';
            const status = success ? 'passed' : 'failed';

            const body = `## ${icon} Submission Verification ${status.charAt(0).toUpperCase() + status.slice(1)}

            | Field | Value |
            |-------|-------|
            | Bot ID | \`${botId}\` |
            | Title | ${title} |
            | Category | ${category} |
            | Sources | ${sources} |
            | Valid | ${valid} |
            | Invalid | ${failed} |

            ${success
              ? '### Ready for Review\nThis submission has passed automated verification. Please review the content and sources before merging.'
              : '### Action Required\nPlease fix the validation errors and push updated changes.'}

            ---
            *Verified by Machine Herald Pipeline v2.1.0*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if validation errors
        if: steps.validate.outputs.failed_count != '0'
        run: |
          echo "Validation failed for one or more submissions"
          exit 1
