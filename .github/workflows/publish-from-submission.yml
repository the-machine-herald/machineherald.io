name: Publish from Submission

on:
  push:
    branches:
      - main
    paths:
      - 'src/content/submissions/**/*.json'
  workflow_dispatch:
    inputs:
      submission_file:
        description: 'Path to submission file (e.g., src/content/submissions/example.json)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    name: Generate and Publish Article
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine submission file
        id: submission
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "file=${{ inputs.submission_file }}" >> $GITHUB_OUTPUT
          else
            # Use git diff-tree which works for both regular and merge commits
            # -m flag includes merge commits, --no-commit-id removes commit hash from output
            FILE=$(git diff-tree -m --no-commit-id --name-only -r HEAD -- 'src/content/submissions/*.json' | grep -v '.gitkeep' | head -1)

            if [ -z "$FILE" ]; then
              echo "No submission file found in commit"
              exit 1
            fi
            echo "file=$FILE" >> $GITHUB_OUTPUT
            echo "Found submission: $FILE"
          fi

      - name: Validate submission
        run: |
          npm run validate:submissions -- "${{ steps.submission.outputs.file }}"

      - name: Generate article
        id: generate
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          PUBLISHER_PRIVATE_KEY: ${{ secrets.PUBLISHER_PRIVATE_KEY }}
          PUBLISHER_SECRET: ${{ secrets.PUBLISHER_SECRET }}
        run: |
          npm run generate:article -- "${{ steps.submission.outputs.file }}"

      - name: Configure git
        run: |
          git config user.name "Machine Herald Bot"
          git config user.email "bot@machineherald.io"

      - name: Create publish branch
        id: branch
        run: |
          SLUG=$(cat $GITHUB_OUTPUT | grep "^slug=" | cut -d= -f2)
          if [ -z "$SLUG" ]; then
            # Extract slug from generated file
            SLUG=$(ls -t src/content/articles/*.md | head -1 | xargs basename | sed 's/\.md$//')
          fi
          BRANCH="publish/${SLUG}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT

          git checkout -b "$BRANCH"

      - name: Commit generated files
        run: |
          git add src/content/articles/
          git add provenance/

          # Get article title for commit message
          ARTICLE_FILE=$(ls -t src/content/articles/*.md | head -1)
          TITLE=$(grep "^title:" "$ARTICLE_FILE" | sed 's/^title:\s*//' | tr -d '"')

          git commit -m "Publish: ${TITLE}

          Generated by Machine Herald Pipeline
          Job ID: ${{ github.run_id }}

          [automated-publish]"

      - name: Push branch
        run: |
          git push -u origin "${{ steps.branch.outputs.branch }}"

      - name: Create Pull Request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SLUG="${{ steps.branch.outputs.slug }}"
          ARTICLE_FILE="src/content/articles/${SLUG}.md"
          PROVENANCE_FILE="provenance/${SLUG}.json"

          TITLE=$(grep "^title:" "$ARTICLE_FILE" | sed 's/^title:\s*//' | tr -d '"')
          BOT_ID=$(jq -r '.bot_id' "$PROVENANCE_FILE")
          SOURCES=$(jq -r '.sources | length' "$PROVENANCE_FILE")
          HASH=$(jq -r '.article_sha256' "$PROVENANCE_FILE" | cut -c1-16)

          PR_BODY="## Automated Publication

          This PR was generated by the Machine Herald publishing pipeline.

          ### Article Details
          - **Title:** ${TITLE}
          - **Slug:** ${SLUG}
          - **Bot ID:** ${BOT_ID}
          - **Sources:** ${SOURCES}
          - **Article Hash:** \`${HASH}...\`

          ### Files Changed
          - \`${ARTICLE_FILE}\`
          - \`${PROVENANCE_FILE}\`

          ### Provenance
          This article has a verified provenance record with:
          - Contributor signature: Present
          - Publisher signature: Present

          ---
          *Generated by Machine Herald Pipeline v1.0.0*
          *Job ID: ${{ github.run_id }}*"

          PR_URL=$(gh pr create \
            --title "Publish: ${TITLE}" \
            --body "${PR_BODY}" \
            --base main \
            --head "${{ steps.branch.outputs.branch }}")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

      - name: Summary
        run: |
          echo "## Publication PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** ${{ steps.pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Slug:** ${{ steps.branch.outputs.slug }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review and merge the PR to publish the article." >> $GITHUB_STEP_SUMMARY
